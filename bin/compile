#!/bin/bash
# bin/compile BUILD_DIR CACHE_DIR ENV_DIR

set -e            # fail fast
set -o nounset    # fail on unset variables

indent() {
  sed -u 's/^/       /'
}

header() {
  echo "-----> $*"
}

header "Install ImageMagick"

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

VENDOR_DIR="$BUILD_DIR/vendor"
INSTALL_DIR="$VENDOR_DIR/imagemagick"

IMAGEMAGICK_VERSION="$(test -f $ENV_DIR/IMAGEMAGICK_VERSION && cat $ENV_DIR/IMAGEMAGICK_VERSION)"
IMAGEMAGICK_VERSION=${IMAGEMAGICK_VERSION:-6.9.3-10}

IMAGEMAGICK_CACHED_BUILD="$CACHE_DIR/imagemagick.tar.gz"

echo $IMAGEMAGICK_VERSION

if [ "$IMAGEMAGICK_VERSION" != "$(cat "$CACHE_DIR/IMAGEMAGICK_VERSION")" ]; then
  echo "New version detected"
  echo $IMAGEMAGICK_VERSION > "$CACHE_DIR/IMAGEMAGICK_VERSION"
  rm -f "$IMAGEMAGICK_CACHED_BUILD"
fi

if [ -f "$IMAGEMAGICK_CACHED_BUILD" ]; then
  header "Extracting ImageMagick $CACHE_FILE => $VENDOR_DIR"
  tar xzf $CACHE_FILE -C $VENDOR_DIR
else
  IMAGEMAGICK_FILE="ImageMagick-$IMAGEMAGICK_VERSION.tar.gz"
  IMAGEMAGICK_DIR="ImageMagick-$IMAGEMAGICK_VERSION"
  # SSL cert used on imagemagick not recognized by heroku.
  IMAGEMAGICK_URL="http://www.imagemagick.org/download/releases/$IMAGEMAGICK_FILE"

  header "Downloading ImageMagick from $IMAGEMAGICK_URL"
  wget $IMAGEMAGICK_URL -P $BUILD_DIR | indent

  header "Extracting ImageMagick from $BUILD_DIR/$IMAGEMAGICK_FILE"
  if [ ! -f $BUILD_DIR/$IMAGEMAGICK_FILE ]; then
    echo "Error: Unable to download image magick" | indent
    ls $BUILD_DIR | indent
    exit 1;
  fi
  tar xvf $BUILD_DIR/$IMAGEMAGICK_FILE | indent

  header "Building ImageMagick"
  cd $IMAGEMAGICK_DIR
  export CPPFLAGS="-I$INSTALL_DIR/include"
  export LDFLAGS="-L$INSTALL_DIR/lib"
  ./configure --prefix=$INSTALL_DIR
  make && make install
  cd ..
  rm -rf $IMAGEMAGICK_DIR

  header "Caching ImageMagick installation"
  cd $VENDOR_DIR
  REL_INSTALL_DIR="imagemagick"
  tar czf $REL_INSTALL_DIR.tar.gz $REL_INSTALL_DIR
  mv $REL_INSTALL_DIR.tar.gz $IMAGEMAGICK_CACHED_BUILD
fi

header "Updating environment variables"
PROFILE_PATH="$BUILD_DIR/.profile.d/imagemagick.sh"
ACTUAL_INSTALL_PATH="$HOME/vendor/imagemagick"
mkdir -p $(dirname $PROFILE_PATH)
echo "export PATH=$ACTUAL_INSTALL_PATH/bin:\$PATH" >> $PROFILE_PATH
echo "export LD_LIBRARY_PATH=$ACTUAL_INSTALL_PATH/lib:\$LD_LIBRARY_PATH" >> $PROFILE_PATH

header "Updating configuration file"
mkdir $BUILD_DIR/.magick
cp -rf $VENDOR_DIR/imagemagick/etc/ImageMagick-*/* $BUILD_DIR/.magick/

exit 0;
